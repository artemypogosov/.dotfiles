#!/bin/sh

# Sync dotfiles repo and ensure that dotfiles are tangled correctly afterward

BLUE='\033[1;34m'
RED='\033[1;31m'
NC='\033[0m'

# Go to .dotfiles dir
cd ~/.dotfiles || exit

printf '%s\n' "$PWD"

printf '%b%s%b\n' "$BLUE" "Stashing existing changes..." "$NC"
# Use git stash push and check exit status
if git stash push -m "sync-dotfiles: Before syncing dotfiles" | grep -q "No local changes to save"; then
  needs_pop=0
else
  needs_pop=1
fi

printf '%b%s%b\n' "$BLUE" "Pulling updates from dotfiles repo..." "$NC"
echo
git pull origin master
echo

if [ "$needs_pop" -eq 1 ]; then
  printf '%b%s%b\n' "$BLUE" "Popping stashed changes..." "$NC"
  echo
  git stash pop
fi

unmerged_files=$(git diff --name-only --diff-filter=U)
if [ -n "$unmerged_files" ]; then
  printf '%b%s%b\n' "$RED" "The following files have merge conflicts after popping the stash:" "$NC"
  echo
  printf '%s\n' "$unmerged_files"
else
  printf '%b%s%b\n' "$BLUE" "Restowing packages..." "$NC"
  # Iterate through directories to prevent stow from failing on empty or malformed globs
  for dir in */; do
    if [ -d "$dir" ]; then
      # Remove trailing slash for stow package naming
      package="${dir%/}"
      stow --restow --no-folding "$package"
    fi
  done
fi
